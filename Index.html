<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Command Center · Nikita</title>
  <meta name="description" content="Interactive trip guide with clickable pins, itinerary, restaurants, photo spots, and budget. Multi-trip ready." />
  <meta name="theme-color" content="#0b0d10" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg: #0b0d10;
      --text: #eef2f6;
      --muted: #a8b3c1;
      --line: rgba(255,255,255,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --max: 1180px;

      --cta: #ffffff;
      --ctaText:#0b0d10;

      --good: rgba(184,199,255,.18);
      --chip: rgba(255,255,255,.06);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(184,199,255,.14), transparent 60%),
        radial-gradient(800px 450px at 80% 10%, rgba(255,255,255,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding: 18px 16px 92px}

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px;
      padding: 8px 0 14px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(11,13,16,.55);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; gap:10px; align-items:center; padding: 0 4px}
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, rgba(184,199,255,.9), rgba(255,255,255,.85));
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .brand h1{font-size:14px; margin:0; font-weight:750; letter-spacing:.2px}
    .brand p{margin:0; font-size:12px; color:var(--muted)}

    .nav{
      display:flex; gap:10px; align-items:center;
      font-size:13px; color:var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
      padding-right: 4px;
    }

    .select{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      outline: none;
      font-weight: 650;
      cursor: pointer;
    }

    .nav a{
      padding:10px 10px;
      border-radius:12px;
      border: 1px solid transparent;
    }
    .nav a:hover{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-color: rgba(255,255,255,.06);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
      transition:.18s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btnPrimary{
      background: var(--cta);
      color: var(--ctaText);
      border-color: transparent;
    }
    .btnPrimary:hover{background: rgba(255,255,255,.92)}

    /* Layout */
    .hero{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items: stretch;
      margin-top: 12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .heroCopy{padding: 18px}
    .kicker{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 12px;
    }
    .heroCopy h2{
      margin: 0 0 10px;
      font-size: clamp(26px, 3.6vw, 42px);
      letter-spacing: -0.8px;
      line-height: 1.06;
    }
    .heroCopy .sub{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 15px;
      max-width: 62ch;
    }
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px}
    .metaRow{
      display:flex; gap:8px; flex-wrap:wrap; margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      padding: 9px 11px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }

    /* Map card */
    .mapCard{padding: 12px; display:flex; flex-direction:column; gap:10px}
    .mapTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 2px 2px 0;
    }
    .mapTop h3{margin:0; font-size: 14px}
    .mapTop span{color:var(--muted); font-size:12px}

    .mapShell{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: #0a0d12;
      min-height: 440px;
      flex: 1;
    }
    #map{
      width:100%;
      height: 440px;
      filter: saturate(1.1) contrast(1.05);
    }

    /* Map overlay UI */
    .mapOverlay{
      position:absolute;
      left: 10px;
      top: 10px;
      right: 10px;
      display:flex;
      gap: 10px;
      justify-content: space-between;
      pointer-events: none;
      z-index: 5;
    }
    .mapOverlay .chipBar{
      display:flex; gap:8px; flex-wrap:wrap;
      pointer-events: auto;
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(11,13,16,.60);
      backdrop-filter: blur(10px);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition:.15s;
    }
    .chip:hover{background: rgba(255,255,255,.08); color: var(--text)}
    .chip.active{
      background: var(--good);
      color: var(--text);
      border-color: rgba(184,199,255,.25);
    }
    .mapRightButtons{
      display:flex; gap:8px;
      pointer-events: auto;
    }
    .miniBtn{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(11,13,16,.60);
      backdrop-filter: blur(10px);
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
    }
    .miniBtn:hover{background: rgba(255,255,255,.09)}

    /* Trip tabs (in-map) */
    .tripTabs{
      position:absolute;
      left: 10px;
      bottom: 10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      z-index: 6;
    }

    /* Drawer (pins / previews) */
    .drawer{
      position:absolute;
      top: 10px;
      right: 10px;
      width: min(380px, calc(100% - 20px));
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(11,13,16,.72);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 10;
    }
    .drawer.show{display:block}
    .drawerHead{
      padding: 12px 12px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .drawerTitle{display:flex; flex-direction:column; gap:2px}
    .drawerTitle strong{font-size: 13px}
    .drawerTitle span{font-size: 12px; color: var(--muted)}
    .xbtn{
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
    }
    .drawerBody{padding: 12px}
    .search{
      display:flex; gap:8px; margin-bottom: 10px;
    }
    .search input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-weight: 650;
    }
    .drawerActions{display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px}
    .hint{color: var(--muted); font-size: 12px; margin: 0 0 8px}

    .poiList{display:flex; flex-direction:column; gap:8px; max-height: 300px; overflow:auto; padding-right: 2px}
    .poiItem{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.12s;
    }
    .poiItem:hover{background: rgba(255,255,255,.07)}
    .poiItem strong{display:block; font-size: 13px}
    .poiItem span{display:block; font-size: 12px; color: var(--muted); margin-top: 2px}
    .anchorNote{margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap}

    /* Sections */
    .section{margin-top: 18px}
    .sectionHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .sectionHead h3{margin:0; font-size: 18px; letter-spacing:-.2px}
    .sectionHead p{margin:0; color:var(--muted); font-size: 13px}

    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    .mini{padding: 14px}
    .mini h4{margin:0 0 6px; font-size: 14px}
    .mini p{margin:0; color:var(--muted); font-size: 13px}

    /* Itinerary accordion */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
    }
    details{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      margin-bottom: 10px;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding: 14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
    }
    summary::-webkit-details-marker{display:none}
    .sumMeta{color:var(--muted); font-weight:650; font-size: 12px}
    .detailsBody{padding: 0 14px 14px; color: var(--muted); font-size: 13px}
    .detailsBody ul{margin:10px 0 0; padding-left: 18px}
    .detailsBody li{margin:6px 0}

    /* Cards for restaurants / photo spots / budget */
    .cards{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    .rcard{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .rcard h4{margin:0 0 6px; font-size: 14px}
    .rcard p{margin:0; color: var(--muted); font-size: 13px}
    .chipsRow{display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Footer */
    .footer{
      margin-top: 18px;
      padding: 18px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
      gap: 14px;
    }
    .fcol h5{margin:0 0 8px; font-size: 13px}
    .fcol a, .fcol p{
      display:block;
      margin: 0 0 7px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .fcol a:hover{color: var(--text)}
    .fineprint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 11px;
      opacity: .9;
      grid-column: 1 / -1;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 10px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Sticky mobile CTA */
    .stickyCta{
      position:fixed;
      left: 0; right:0; bottom:0;
      padding: 10px 12px;
      background: rgba(11,13,16,.78);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
      display:none;
      z-index: 99;
    }
    .stickyRow{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .stickyRow .btn{flex:1}

    @media (max-width: 1020px){
      .hero{grid-template-columns: 1fr}
      #map{height: 380px}
      .mapShell{min-height: 380px}
      .grid3{grid-template-columns: 1fr}
      .cards{grid-template-columns: 1fr}
      .footer{grid-template-columns: 1fr 1fr}
    }
    @media (max-width: 720px){
      .nav a{display:none}
      .stickyCta{display:block}
      .wrap{padding-bottom: 118px}
      .footer{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <div class="wrap" id="top">
    <!-- Top Bar -->
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="siteTitle">Trip Command Center · Nikita</h1>
          <p id="siteSubtitle">Interactive guide · pins · plan · food · photos</p>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <!-- Multi-trip navigation (scales) -->
        <select class="select" id="tripSelect" aria-label="Select trip"></select>

        <a href="#itinerary">Itinerary</a>
        <a href="#restaurants">Restaurants</a>
        <a href="#photos">Photo spots</a>
        <a href="#budget">Budget</a>
        <a href="#mapSection">Map</a>

        <a class="btn btnPrimary" id="openMapBtn" href="#" target="_blank" rel="noopener">Open Google Map</a>
      </nav>
    </header>

    <!-- Hero -->
    <section class="hero">
      <div class="card heroCopy">
        <div class="kicker" id="kickerText">Loading…</div>
        <h2 id="heroTitle">Loading…</h2>
        <p class="sub" id="heroSub">Loading…</p>

        <div class="heroActions">
          <a class="btn btnPrimary" id="primaryCta" href="#" target="_blank" rel="noopener">Open Live Google Map</a>
          <a class="btn" href="#mapSection">Use Interactive Map</a>
          <button class="btn" id="openDrawerBtn" type="button">Search Pins</button>
        </div>

        <div class="metaRow" id="metaRow"></div>
      </div>

      <!-- Map -->
      <div class="card mapCard" id="mapSection">
        <div class="mapTop">
          <div>
            <h3>Interactive Map</h3>
            <span>Trip tabs + pin previews + jump to plan</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="fitBtn" type="button">Fit to Pins</button>
            <button class="btn" id="drawerBtn2" type="button">Pins</button>
          </div>
        </div>

        <div class="mapShell">
          <div id="map" aria-label="Interactive map"></div>

          <!-- Top overlay: category filters -->
          <div class="mapOverlay">
            <div class="chipBar" id="filterChips"></div>
            <div class="mapRightButtons">
              <button class="miniBtn" id="toggleLabelsBtn" type="button">Labels</button>
            </div>
          </div>

          <!-- Bottom overlay: Trip Tabs (your “another tab/pin in the map button”) -->
          <div class="tripTabs" id="tripTabs"></div>

          <!-- Pins drawer -->
          <aside class="drawer" id="drawer" aria-label="Pins drawer">
            <div class="drawerHead">
              <div class="drawerTitle">
                <strong id="drawerTitle">Pins</strong>
                <span id="drawerSubtitle">Search + click to preview</span>
              </div>
              <button class="xbtn" id="closeDrawerBtn" type="button">✕</button>
            </div>
            <div class="drawerBody">
              <p class="hint" id="drawerHint">Search by name, city, category, or note.</p>
              <div class="search">
                <input id="searchInput" type="text" placeholder="Search pins…" />
                <button class="btn" id="clearSearchBtn" type="button">Clear</button>
              </div>

              <div class="poiList" id="poiList"></div>

              <div class="drawerActions">
                <a class="btn btnPrimary" id="drawerOpenGoogleBtn" href="#" target="_blank" rel="noopener">Open Google Map</a>
                <button class="btn" id="copyShareBtn" type="button">Copy Share Link</button>
              </div>

              <p class="hint" style="margin-top:10px">
                Pin preview includes “Open full plan” to jump to the exact day/section.
              </p>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <!-- Value props -->
    <section class="section">
      <div class="grid3">
        <div class="card mini">
          <h4>Built to execute</h4>
          <p>Not a blog. A runbook you can operate from your phone.</p>
        </div>
        <div class="card mini">
          <h4>Map-first experience</h4>
          <p>Trip tabs + filters + previews. No scrolling walls of text.</p>
        </div>
        <div class="card mini">
          <h4>Scales to many trips</h4>
          <p>Add another trip by copying one object in the trips array.</p>
        </div>
      </div>
    </section>

    <!-- Itinerary -->
    <section class="section" id="itinerary">
      <div class="sectionHead">
        <div>
          <h3>Itinerary</h3>
          <p>Expand only what you need. Fast scan, low friction.</p>
        </div>
        <a class="btn btnPrimary" id="itineraryOpenMapBtn" href="#" target="_blank" rel="noopener">Open Google Map</a>
      </div>
      <div class="panel" id="itineraryContainer"></div>
    </section>

    <!-- Restaurants -->
    <section class="section" id="restaurants">
      <div class="sectionHead">
        <div>
          <h3>Restaurants (recommendations)</h3>
          <p>Mid / cheap-mid biased. No tourist-trap fluff.</p>
        </div>
      </div>
      <div class="cards" id="restaurantCards"></div>
    </section>

    <!-- Photo Spots -->
    <section class="section" id="photos">
      <div class="sectionHead">
        <div>
          <h3>Photo spots (your “course for pictures”)</h3>
          <p>Where to shoot + best light + what shot to take.</p>
        </div>
      </div>
      <div class="cards" id="photoCards"></div>
    </section>

    <!-- Budget -->
    <section class="section" id="budget">
      <div class="sectionHead">
        <div>
          <h3>Budget</h3>
          <p>Optional, collapsible, useful when planning.</p>
        </div>
      </div>
      <div class="panel" id="budgetPanel"></div>
    </section>

    <!-- Footer -->
    <footer class="footer" id="footer">
      <div class="fcol">
        <h5 id="footerBrand">Trip Command Center</h5>
        <p id="footerDesc">An interactive trip guide: map + plan + food + photo spots.</p>
        <p id="footerMeta">Built for fast decisions, not endless browsing.</p>
      </div>

      <div class="fcol">
        <h5>Trips</h5>
        <div id="footerTrips"></div>
      </div>

      <div class="fcol">
        <h5>Quick links</h5>
        <a href="#mapSection">Interactive map</a>
        <a href="#itinerary">Itinerary</a>
        <a href="#restaurants">Restaurants</a>
        <a href="#photos">Photo spots</a>
        <a href="#budget">Budget</a>
      </div>

      <div class="fcol">
        <h5>Actions</h5>
        <a id="footerOpenMap" href="#" target="_blank" rel="noopener">Open Google Map</a>
        <a href="#top">Back to top</a>
        <a href="#" id="footerShare">Copy share link</a>
      </div>

      <div class="fineprint">
        <span>© <span id="year"></span> · Personal trip guide</span>
        <span>Disclaimer: verify hours, tickets, and closures locally.</span>
      </div>
    </footer>
  </div>

  <!-- Sticky mobile CTA -->
  <div class="stickyCta" role="region" aria-label="Quick actions">
    <div class="stickyRow">
      <a class="btn btnPrimary" id="stickyOpenMap" href="#" target="_blank" rel="noopener">Open Map</a>
      <button class="btn" id="stickyPins" type="button">Pins</button>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // =========================================================
    // MULTI-TRIP DATA MODEL (scales to many trips)
    // Add trips by duplicating an object in `trips`.
    // Later, you can load this from JSON files instead.
    // =========================================================
    const trips = [
      // -------------------------
      // TRIP 1: PERU (your existing)
      // -------------------------
      {
        id: "peru-jan",
        name: "Peru Trip (Jan 15–21)",
        short: "Lima → Paracas → Cusco → Machu Picchu → Nazca → Lima",
        googleMapUrl: "https://maps.app.goo.gl/uTUuF275HcNx2AcP6?g_st=i",
        heroTitle: "Peru, Run Hour-by-Hour. Zero Guesswork.",
        heroSub: "Interactive map + pins + itinerary + restaurants + photo spots. Built to run from your phone.",
        meta: ["Optimized for time", "Mid / cheap-mid food", "Pin previews + deep links", "Multi-trip ready"],
        mapView: { center: [-12.0464, -77.0428], zoom: 5 },
        categories: [
          { key: "logistics", label: "Logistics" },
          { key: "attraction", label: "Attractions" },
          { key: "food", label: "Food" },
          { key: "photo", label: "Photo" }
        ],
        pois: [
          { id:"lim-airport", name:"Jorge Chávez Intl Airport (LIM)", city:"Lima", cat:"logistics", lat:-12.0219, lng:-77.1143, note:"Arrivals / rental car / departure.", planAnchor:"#day-jan15", googleQuery:"Jorge Chávez International Airport" },
          { id:"pachacamac", name:"Pachacamac Archaeological Complex", city:"Lima", cat:"attraction", lat:-12.2639, lng:-76.8746, note:"Morning archaeology hit.", planAnchor:"#day-jan15", googleQuery:"Pachacamac Archaeological Complex" },
          { id:"mamacona", name:"Hacienda Mamacona", city:"Lima", cat:"food", lat:-12.2616, lng:-76.8790, note:"Brunch stop near Pachacamac.", planAnchor:"#day-jan15", googleQuery:"Hacienda Mamacona" },
          { id:"tanta", name:"Tanta (Larcomar)", city:"Lima", cat:"food", lat:-12.1310, lng:-77.0305, note:"Safe Peruvian comfort; ocean view.", planAnchor:"#day-jan15", googleQuery:"Tanta Larcomar" },
          { id:"lalucha", name:"La Lucha (Miraflores)", city:"Lima", cat:"food", lat:-12.1254, lng:-77.0309, note:"Fast, cheap, reliable.", planAnchor:"#day-jan15", googleQuery:"La Lucha Sanguchería Miraflores" },
          { id:"panchita", name:"Panchita", city:"Lima", cat:"food", lat:-12.1190, lng:-77.0295, note:"Traditional classics. Busy.", planAnchor:"#day-jan20", googleQuery:"Panchita Miraflores" },
          { id:"parque-amor", name:"Parque del Amor (cliffs)", city:"Lima", cat:"photo", lat:-12.1322, lng:-77.0306, note:"Sunset clifftop walk.", planAnchor:"#day-jan20", googleQuery:"Parque del Amor Miraflores" },
          { id:"paracas-reserve", name:"Paracas National Reserve", city:"Paracas", cat:"attraction", lat:-13.8512, lng:-76.2719, note:"Quick loop viewpoints.", planAnchor:"#day-jan15", googleQuery:"Reserva Nacional de Paracas" },
          { id:"playa-roja", name:"Playa Roja", city:"Paracas", cat:"photo", lat:-13.8669, lng:-76.2680, note:"Red sand + cliffs.", planAnchor:"#day-jan15", googleQuery:"Playa Roja Paracas" },
          { id:"pukasoncco", name:"Pukasoncco", city:"Paracas", cat:"food", lat:-13.8366, lng:-76.2508, note:"Home-style, good prices.", planAnchor:"#day-jan15", googleQuery:"Pukasoncco Arte y Restaurante Paracas" },
          { id:"hacienda-sanjose", name:"Hacienda San José", city:"Chincha", cat:"attraction", lat:-13.4309, lng:-76.1306, note:"Colonial house + tunnels.", planAnchor:"#day-jan15", googleQuery:"Hacienda San José Chincha" },
          { id:"cus-airport", name:"Cusco Airport (CUZ)", city:"Cusco", cat:"logistics", lat:-13.5357, lng:-71.9388, note:"Acclimatize day 1.", planAnchor:"#day-jan16", googleQuery:"Alejandro Velasco Astete International Airport" },
          { id:"plaza-cusco", name:"Plaza de Armas (Cusco)", city:"Cusco", cat:"attraction", lat:-13.5164, lng:-71.9781, note:"Base zone.", planAnchor:"#day-jan16", googleQuery:"Plaza de Armas Cusco" },
          { id:"qorikancha", name:"Qorikancha", city:"Cusco", cat:"attraction", lat:-13.5220, lng:-71.9753, note:"Temple of the Sun.", planAnchor:"#day-jan16", googleQuery:"Qorikancha" },
          { id:"jacks", name:"Jack’s Café", city:"Cusco", cat:"food", lat:-13.5169, lng:-71.9775, note:"Value + big portions.", planAnchor:"#day-jan16", googleQuery:"Jack's Cafe Cusco" },
          { id:"chakruna", name:"Chakruna", city:"Cusco", cat:"food", lat:-13.5169, lng:-71.9766, note:"Cheap + consistent.", planAnchor:"#day-jan16", googleQuery:"Chakruna Native Burgers Cusco" },
          { id:"sacsay", name:"Sacsayhuamán", city:"Cusco", cat:"photo", lat:-13.5099, lng:-71.9818, note:"Stone scale + views.", planAnchor:"#day-jan18", googleQuery:"Sacsayhuaman" },
          { id:"sanpedro", name:"San Pedro Station", city:"Cusco", cat:"logistics", lat:-13.5211, lng:-71.9812, note:"Vistadome option.", planAnchor:"#day-jan17", googleQuery:"Estación de tren San Pedro Cusco" },
          { id:"poroy", name:"Poroy Station", city:"Cusco", cat:"logistics", lat:-13.4959, lng:-72.0390, note:"Hiram Bingham option.", planAnchor:"#day-jan17", googleQuery:"Estación Poroy Cusco" },
          { id:"aguas", name:"Aguas Calientes", city:"Machu Picchu", cat:"logistics", lat:-13.1540, lng:-72.5250, note:"Town base.", planAnchor:"#day-jan17", googleQuery:"Aguas Calientes Machu Picchu" },
          { id:"mp-gate", name:"Machu Picchu (Gate)", city:"Machu Picchu", cat:"attraction", lat:-13.1631, lng:-72.5450, note:"Circuit 2; no re-entry.", planAnchor:"#day-jan17", googleQuery:"Machu Picchu entrance" },
          { id:"nzc-airport", name:"Nazca Airport (NZC)", city:"Nazca", cat:"logistics", lat:-14.8540, lng:-74.9610, note:"Nazca Lines flights.", planAnchor:"#day-jan19", googleQuery:"Aeropuerto Maria Reiche Neuman Nazca" },
          { id:"cantalloc", name:"Cantalloc Aqueducts", city:"Nazca", cat:"attraction", lat:-14.8292, lng:-74.9466, note:"Spiral geometry.", planAnchor:"#day-jan19", googleQuery:"Acueductos de Cantalloc" },
          { id:"chauchilla", name:"Chauchilla Cemetery", city:"Nazca", cat:"attraction", lat:-14.8194, lng:-75.1066, note:"Desert site.", planAnchor:"#day-jan19", googleQuery:"Cementerio de Chauchilla" },
          { id:"mamashana", name:"Mamashana", city:"Nazca", cat:"food", lat:-14.8318, lng:-74.9387, note:"Traveler favorite.", planAnchor:"#day-jan19", googleQuery:"Mamashana Cafe Restaurante Nazca" },
        ],
        itinerary: [
          { id:"day-jan15", title:"JAN 15 — Arrival → Coastal Loop → Lima", meta:"Lima • Pachacamac • Paracas • Chincha",
            items:[
              "05:00–06:00 Land in Lima, immigration, bags",
              "06:00–06:30 Pick up rental car",
              "06:30–07:15 Drive to Pachacamac",
              "07:15–09:00 Pachacamac",
              "09:00–10:00 Brunch: Hacienda Mamacona",
              "10:00–12:45 Drive to Paracas",
              "12:45–14:30 Paracas National Reserve quick loop",
              "14:30–15:30 Late lunch: Pukasoncco",
              "16:30–17:30 Hacienda San José (Chincha)",
              "19:30–21:00 Dinner: La Lucha or Tanta"
            ]
          },
          { id:"day-jan16", title:"JAN 16 — Lima → Cusco (Acclimatization)", meta:"Fly • Easy walking • Qorikancha",
            items:[
              "08:00–09:00 To airport, drop car",
              "09:00–11:00 Flight Lima → Cusco",
              "11:30–13:00 Check-in + lunch: Chakruna",
              "13:00–15:00 Plaza de Armas + Cathedral",
              "15:00–16:30 Qorikancha",
              "17:00–18:30 Dinner: Jack’s Café"
            ]
          },
          { id:"day-jan17", title:"JAN 17 — Machu Picchu Day (Option A or B)", meta:"Circuit 2 • no re-entry",
            items:[
              "Option A: Hiram Bingham (Poroy)",
              "Option B: Vistadome (San Pedro)",
              "No toilets inside MP; no re-entry; eat before entering."
            ]
          },
          { id:"day-jan18", title:"JAN 18 — Cusco Day + Night Bus to Nazca", meta:"Sacsayhuamán • San Blas",
            items:[
              "10:00–12:00 Sacsayhuamán",
              "12:15–13:00 Q’enqo",
              "13:15–14:00 Lunch: Pachapapa or Green Point Vegan",
              "19:30 Taxi to bus station",
              "~20:00–05:30 Night bus Cusco → Nazca"
            ]
          },
          { id:"day-jan19", title:"JAN 19 — Nazca Lines Flight + Desert", meta:"NZC • Cantalloc • Chauchilla",
            items:[
              "07:00–09:00 Nazca Lines Flight",
              "10:30–12:00 Cantalloc Aqueducts",
              "15:00–17:30 Chauchilla Cemetery + desert stop",
              "Dinner: Mamashana"
            ]
          },
          { id:"day-jan20", title:"JAN 20 — Nazca → Lima + Miraflores Sunset", meta:"Bus • Clifftop walk",
            items:[
              "07:30–14:00 Bus Nazca → Lima",
              "16:00–18:30 Miraflores clifftop walk",
              "19:30–21:30 Dinner: Panchita or Siete Sopas"
            ]
          },
          { id:"day-jan21", title:"JAN 21 — Lima → Norfolk", meta:"Free morning • airport buffer",
            items:[
              "Free morning",
              "T-3h taxi to airport",
              "Fly Lima → US → Norfolk"
            ]
          }
        ],
        restaurants: [
          { name:"La Lucha", city:"Lima", vibe:"Fast + cheap", why:"Reliable, quick.", price:"$", google:"La Lucha Sanguchería Miraflores" },
          { name:"Tanta (Larcomar)", city:"Lima", vibe:"Comfort", why:"Safe default with views.", price:"$$", google:"Tanta Larcomar" },
          { name:"Panchita", city:"Lima", vibe:"Traditional", why:"Great classics; crowded.", price:"$$", google:"Panchita Miraflores" },
          { name:"Jack’s Café", city:"Cusco", vibe:"Value", why:"Big plates; consistent.", price:"$", google:"Jack's Cafe Cusco" },
          { name:"Chakruna", city:"Cusco", vibe:"Quick", why:"Cheap when tired.", price:"$", google:"Chakruna Native Burgers Cusco" },
          { name:"Pukasoncco", city:"Paracas", vibe:"Home-style", why:"Good prices.", price:"$", google:"Pukasoncco Arte y Restaurante Paracas" },
          { name:"Mamashana", city:"Nazca", vibe:"All-day", why:"Traveler staple.", price:"$", google:"Mamashana Cafe Restaurante Nazca" }
        ],
        photoSpots: [
          { name:"Parque del Amor (cliffs)", city:"Lima", best:"Sunset", shot:"Cliffs + silhouette", tip:"0.5x lens; keep horizon straight.", google:"Parque del Amor Miraflores" },
          { name:"Playa Roja", city:"Paracas", best:"Midday contrast", shot:"Red sand curve + cliff", tip:"Expose for highlights; reds clip fast.", google:"Playa Roja Paracas" },
          { name:"Sacsayhuamán", city:"Cusco", best:"Morning", shot:"Stone scale wide", tip:"Low angle exaggerates blocks.", google:"Sacsayhuaman" },
          { name:"Cantalloc Aqueducts", city:"Nazca", best:"Late morning", shot:"Spiral geometry", tip:"Shoot symmetry from above.", google:"Acueductos de Cantalloc" }
        ],
        budget: null
      },

      // -------------------------
      // TRIP 2: YUCATÁN / MEXICO (integrated)
      // NOTE: If you want perfect POI placement, add lat/lng later.
      // -------------------------
      {
        id: "yucatan-8d",
        name: "Yucatán (8 Days) · Base Playa del Carmen",
        short: "Playa del Carmen base → Tulum → Cozumel → Cobá → Cenotes → Isla Mujeres / Akumal",
        googleMapUrl: "#", // You can add your Google map link here later
        heroTitle: "Yucatán, Designed Like a Product.",
        heroSub: "8-day command-center plan based in Playa del Carmen: ruins, cenotes, beach, Cozumel, and a birthday day built in.",
        meta: ["Base: Playa del Carmen", "Ruins + cenotes + islands", "Birthday day included", "Mid-price food picks"],
        mapView: { center: [20.6296, -87.0739], zoom: 9 },
        categories: [
          { key: "logistics", label: "Logistics" },
          { key: "attraction", label: "Attractions" },
          { key: "food", label: "Food" },
          { key: "photo", label: "Photo" }
        ],
        pois: [
          // Base / logistics
          { id:"reef28", name:"The Reef 28 Hotel", city:"Playa del Carmen", cat:"logistics", lat:20.6299, lng:-87.0722, note:"Main base hotel.", planAnchor:"#mex-day1", googleQuery:"The Reef 28 Playa del Carmen" },
          { id:"quinta", name:"Quinta Avenida", city:"Playa del Carmen", cat:"attraction", lat:20.6294, lng:-87.0718, note:"Walk, shops, night energy.", planAnchor:"#mex-day1", googleQuery:"Quinta Avenida Playa del Carmen" },

          // Food (key mentions)
          { id:"lapperla", name:"La Perla Pixan (Cuisine & Mezcal)", city:"Playa del Carmen", cat:"food", lat:20.6278, lng:-87.0736, note:"Dinner option day 1.", planAnchor:"#mex-day1", googleQuery:"La Perla Pixan Playa del Carmen" },
          { id:"elfogon", name:"El Fogón", city:"Playa del Carmen", cat:"food", lat:20.6324, lng:-87.0735, note:"Strong taco pick.", planAnchor:"#mex-day2", googleQuery:"El Fogon Playa del Carmen" },

          // Tulum day
          { id:"tulumruins", name:"Tulum Archaeological Zone", city:"Tulum", cat:"attraction", lat:20.2149, lng:-87.4290, note:"Cliffside ruins + sea views.", planAnchor:"#mex-day2", googleQuery:"Tulum Archaeological Zone" },
          { id:"playaparaiso", name:"Playa Paraíso", city:"Tulum", cat:"photo", lat:20.2043, lng:-87.4413, note:"Turquoise beach; midday color.", planAnchor:"#mex-day2", googleQuery:"Playa Paraiso Tulum" },
          { id:"grancenote", name:"Gran Cenote", city:"Tulum", cat:"attraction", lat:20.3017, lng:-87.4818, note:"Swim option; go early.", planAnchor:"#mex-day2", googleQuery:"Gran Cenote" },
          { id:"rawlove", name:"Raw Love", city:"Tulum", cat:"food", lat:20.1525, lng:-87.4514, note:"Lunch option (Tulum).", planAnchor:"#mex-day2", googleQuery:"Raw Love Tulum" },
          { id:"arca", name:"ARCA", city:"Tulum", cat:"food", lat:20.1468, lng:-87.4540, note:"Birthday dinner (sunset / night).", planAnchor:"#mex-day3", googleQuery:"ARCA Tulum" },

          // Cozumel day
          { id:"coz-ferry", name:"Ferry Playa del Carmen ↔ Cozumel", city:"Playa del Carmen", cat:"logistics", lat:20.6256, lng:-87.0771, note:"Morning ferry recommended.", planAnchor:"#mex-day4", googleQuery:"Cozumel ferry Playa del Carmen" },
          { id:"puntasur", name:"Punta Sur Eco Beach Park", city:"Cozumel", cat:"attraction", lat:20.2520, lng:-86.9770, note:"Nature park stop.", planAnchor:"#mex-day4", googleQuery:"Punta Sur Eco Beach Park" },
          { id:"palancar", name:"Palancar Reef", city:"Cozumel", cat:"attraction", lat:20.3000, lng:-87.0400, note:"Snorkel / reef.", planAnchor:"#mex-day4", googleQuery:"Palancar Reef" },

          // Coba + cenotes
          { id:"coba", name:"Cobá Ruins", city:"Cobá", cat:"attraction", lat:20.4901, lng:-87.7327, note:"Jungle ruins day.", planAnchor:"#mex-day5", googleQuery:"Coba Ruins" },
          { id:"chooha", name:"Cenote Choo-Ha", city:"Cobá", cat:"attraction", lat:20.4912, lng:-87.7407, note:"Cenote option near Cobá.", planAnchor:"#mex-day5", googleQuery:"Cenote Choo-Ha" },
          { id:"multumha", name:"Cenote Multum-Ha", city:"Cobá", cat:"attraction", lat:20.4856, lng:-87.7398, note:"Cenote option near Cobá.", planAnchor:"#mex-day5", googleQuery:"Cenote Multum Ha" },
          { id:"donsirloin", name:"Don Sirloin", city:"Playa del Carmen", cat:"food", lat:20.6290, lng:-87.0705, note:"Dinner option.", planAnchor:"#mex-day5", googleQuery:"Don Sirloin Playa del Carmen" },

          // Choice days
          { id:"islamuj", name:"Isla Mujeres", city:"Isla Mujeres", cat:"photo", lat:21.2320, lng:-86.7310, note:"Option day; beaches + photos.", planAnchor:"#mex-day6", googleQuery:"Isla Mujeres" },
          { id:"akumal", name:"Akumal Beach (turtles)", city:"Akumal", cat:"attraction", lat:20.3952, lng:-87.3150, note:"Option day; turtle snorkeling.", planAnchor:"#mex-day6", googleQuery:"Akumal Beach turtles" },

          // Xcaret option
          { id:"xcaret", name:"Xcaret Park", city:"Near Playa del Carmen", cat:"attraction", lat:20.5806, lng:-87.1166, note:"Option day; big park day.", planAnchor:"#mex-day7", googleQuery:"Xcaret Park" },
        ],
        itinerary: [
          { id:"mex-day1", title:"Day 1 — Arrival + Relaxation", meta:"Check-in • Rooftop • Quinta Avenida",
            items:[
              "Check-in: The Reef 28 Hotel",
              "Rooftop pool + decompress",
              "Walk Quinta Avenida (evening)",
              "Dinner: La Perla Pixan (Cuisine & Mezcal)"
            ]
          },
          { id:"mex-day2", title:"Day 2 — Tulum Ruins + Beach / Cenote", meta:"Tulum • Playa Paraíso • Gran Cenote",
            items:[
              "Tulum Archaeological Zone",
              "Swim: Playa Paraíso OR Gran Cenote",
              "Lunch: Raw Love (Tulum)",
              "Dinner: El Fogón"
            ]
          },
          { id:"mex-day3", title:"Day 3 — Birthday Day (Special Occasion)", meta:"Yoga • Beach • ARCA dinner",
            items:[
              "Private yoga on Tulum Beach",
              "Optional: Tulum ruins (if you want repeat/short visit)",
              "Sunset + birthday dinner: ARCA Tulum"
            ]
          },
          { id:"mex-day4", title:"Day 4 — Cozumel Adventure", meta:"Ferry • Punta Sur • Palancar Reef",
            items:[
              "Ferry Playa del Carmen → Cozumel",
              "Punta Sur Eco Park",
              "Snorkeling: Palancar Reef"
            ]
          },
          { id:"mex-day5", title:"Day 5 — Cobá + Cenotes", meta:"Cobá • Choo-Ha • Multum-Ha",
            items:[
              "Cobá Ruins (jungle site)",
              "Cenotes: Choo-Ha + Multum-Ha",
              "Dinner: Don Sirloin"
            ]
          },
          { id:"mex-day6", title:"Day 6 — Choice Day", meta:"Isla Mujeres OR Akumal",
            items:[
              "Option A: Isla Mujeres (ferry + beach)",
              "Option B: Akumal (turtles + cenotes)"
            ]
          },
          { id:"mex-day7", title:"Day 7 — Free Day / Xcaret", meta:"Chill OR full park day",
            items:[
              "Option A: Chill day (Playa del Carmen)",
              "Option B: Xcaret Park"
            ]
          },
          { id:"mex-day8", title:"Day 8 — Departure", meta:"Relax • depart",
            items:[
              "Easy morning",
              "Departure logistics"
            ]
          }
        ],
        restaurants: [
          { name:"La Perla Pixan", city:"Playa del Carmen", vibe:"Dinner + mezcal", why:"Strong first-night anchor.", price:"$$", google:"La Perla Pixan Playa del Carmen" },
          { name:"El Fogón", city:"Playa del Carmen", vibe:"Tacos", why:"Reliable value pick.", price:"$", google:"El Fogon Playa del Carmen" },
          { name:"Raw Love", city:"Tulum", vibe:"Light lunch", why:"Easy day fuel near beach.", price:"$$", google:"Raw Love Tulum" },
          { name:"ARCA", city:"Tulum", vibe:"Birthday dinner", why:"Atmosphere + high-impact night.", price:"$$$", google:"ARCA Tulum" },
          { name:"Don Sirloin", city:"Playa del Carmen", vibe:"Quick dinner", why:"Good post-excursion meal.", price:"$", google:"Don Sirloin Playa del Carmen" }
        ],
        photoSpots: [
          { name:"Playa Paraíso", city:"Tulum", best:"Midday (water color)", shot:"Turquoise shoreline wides + minimal clutter", tip:"Shoot perpendicular to shore for cleaner background.", google:"Playa Paraiso Tulum" },
          { name:"Tulum Ruins (cliff edge)", city:"Tulum", best:"Early morning", shot:"Ruins + sea horizon", tip:"Go early to reduce crowds in frame.", google:"Tulum Archaeological Zone" },
          { name:"Gran Cenote", city:"Tulum", best:"Late morning", shot:"Water reflections + cave openings", tip:"Underexpose slightly to keep highlights.", google:"Gran Cenote" },
          { name:"Isla Mujeres waterfront", city:"Isla Mujeres", best:"Sunset", shot:"Harbor silhouettes", tip:"Lock exposure on sky; let subjects go dark.", google:"Isla Mujeres" },
          { name:"ARCA (night)", city:"Tulum", best:"After dark", shot:"Candle/fire vibe", tip:"Use night mode; keep hands steady.", google:"ARCA Tulum" }
        ],
        budget: {
          headline: "Estimated per-person total: $836",
          items: [
            { label:"Meals", value:"$350" },
            { label:"Transportation", value:"$25" },
            { label:"Activities", value:"$377" },
            { label:"eSIM", value:"$34" },
            { label:"Misc", value:"$50" }
          ]
        }
      }
    ];

    // =========================================================
    // HELPERS
    // =========================================================
    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function makeGoogleLink(query){
      const q = encodeURIComponent(query);
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    // =========================================================
    // MAP
    // =========================================================
    let map, tileLayer, markerLayer = [];
    let activeTrip = trips[0];
    let activeFilters = new Set(); // empty = show all
    let labelsEnabled = true;

    function markerIcon(color){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 34 34">
          <defs>
            <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
              <feDropShadow dx="0" dy="6" stdDeviation="6" flood-color="rgba(0,0,0,.55)"/>
            </filter>
          </defs>
          <g filter="url(#s)">
            <path d="M17 2c6 0 10 4.1 10 10.2 0 7.5-8.4 17.6-10 19.5-1.6-1.9-10-12-10-19.5C7 6.1 11 2 17 2z" fill="${color}" />
            <circle cx="17" cy="12.4" r="4.2" fill="rgba(11,13,16,.95)" />
          </g>
        </svg>`;
      return L.divIcon({
        className: "",
        html: svg,
        iconSize: [34,34],
        iconAnchor: [17,32]
      });
    }

    function colorByCat(cat){
      switch(cat){
        case "logistics": return "rgba(184,199,255,.92)";
        case "attraction": return "rgba(255,255,255,.88)";
        case "food": return "rgba(210,255,210,.80)";
        case "photo": return "rgba(255,220,180,.82)";
        default: return "rgba(255,255,255,.85)";
      }
    }

    function initMap(){
      map = L.map("map", { zoomControl: true, attributionControl: false });

      // Modern-looking tiles (not default Google embed)
      tileLayer = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { subdomains: "abcd", maxZoom: 19 }
      ).addTo(map);

      setTrip(activeTrip);
    }

    function clearMarkers(){
      markerLayer.forEach(m => map.removeLayer(m));
      markerLayer = [];
    }

    function passesFilter(poi){
      if(activeFilters.size === 0) return true;
      return activeFilters.has(poi.cat);
    }

    function addMarkers(){
      clearMarkers();
      const bounds = [];

      for(const poi of activeTrip.pois || []){
        if(typeof poi.lat !== "number" || typeof poi.lng !== "number") continue;
        if(!passesFilter(poi)) continue;

        const m = L.marker([poi.lat, poi.lng], { icon: markerIcon(colorByCat(poi.cat)) });

        if(labelsEnabled){
          m.bindTooltip(escapeHtml(poi.name), { direction:"top", offset:[0,-18], opacity:0.95 });
        }

        m.on("click", () => openPinPreview(poi));
        m.addTo(map);
        markerLayer.push(m);
        bounds.push([poi.lat, poi.lng]);
      }

      if(bounds.length){
        map.fitBounds(bounds, { padding:[40,40] });
      }else{
        map.setView(activeTrip.mapView.center, activeTrip.mapView.zoom);
      }
    }

    // =========================================================
    // DRAWER / PREVIEW
    // =========================================================
    function showDrawer(show){
      const d = $("drawer");
      if(show) d.classList.add("show");
      else d.classList.remove("show");
    }

    function labelForCat(cat){
      const found = (activeTrip.categories || []).find(c => c.key === cat);
      return found ? found.label : cat;
    }

    function openPinPreview(poi){
      showDrawer(true);

      $("drawerTitle").textContent = poi.name;
      $("drawerSubtitle").textContent = `${poi.city || "—"} · ${labelForCat(poi.cat)}`;
      $("drawerHint").textContent = poi.note || "Open full plan to jump to the relevant day.";

      const list = $("poiList");
      const gm = poi.googleQuery || poi.name;
      const openGoogle = activeTrip.googleMapUrl && activeTrip.googleMapUrl !== "#"
        ? activeTrip.googleMapUrl
        : makeGoogleLink(gm);

      list.innerHTML = `
        <div class="poiItem" style="cursor:default">
          <strong>${escapeHtml(poi.name)}</strong>
          <span>${escapeHtml(poi.note || "")}</span>
          <div class="anchorNote">
            <a class="btn btnPrimary" href="${poi.planAnchor || "#itinerary"}">Open full plan</a>
            <a class="btn" href="${makeGoogleLink(gm)}" target="_blank" rel="noopener">Open in Maps</a>
          </div>
        </div>
        <p class="hint">Search other pins above or change filters.</p>
      `;

      if(typeof poi.lat === "number" && typeof poi.lng === "number"){
        map.panTo([poi.lat, poi.lng], { animate:true, duration: 0.5 });
      }

      // Keep the "Open Google Map" button meaningful even if user hasn’t provided a MyMap link yet
      $("drawerOpenGoogleBtn").href = openGoogle;
    }

    function renderPoiList(filterText=""){
      const list = $("poiList");
      const q = filterText.trim().toLowerCase();

      const rows = (activeTrip.pois || [])
        .filter(p => passesFilter(p))
        .filter(p => {
          if(!q) return true;
          return (p.name + " " + (p.city||"") + " " + (p.note||"") + " " + (p.cat||""))
            .toLowerCase()
            .includes(q);
        })
        .slice(0, 120)
        .map(p => `
          <div class="poiItem" data-poi="${escapeHtml(p.id)}">
            <strong>${escapeHtml(p.name)}</strong>
            <span>${escapeHtml((p.city||"") + " · " + labelForCat(p.cat))}</span>
          </div>
        `)
        .join("");

      list.innerHTML = rows || `<p class="hint">No pins match. Clear search or change filters.</p>`;

      list.querySelectorAll(".poiItem[data-poi]").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-poi");
          const poi = (activeTrip.pois || []).find(p => p.id === id);
          if(poi) openPinPreview(poi);
        });
      });
    }

    // =========================================================
    // FILTER CHIPS
    // =========================================================
    function renderFilterChips(){
      const chips = $("filterChips");
      chips.innerHTML = "";

      const allChip = document.createElement("div");
      allChip.className = "chip" + (activeFilters.size===0 ? " active": "");
      allChip.textContent = "All";
      allChip.addEventListener("click", () => {
        activeFilters.clear();
        renderFilterChips();
        addMarkers();
        renderPoiList($("searchInput").value);
      });
      chips.appendChild(allChip);

      for(const c of (activeTrip.categories || [])){
        const chip = document.createElement("div");
        const active = activeFilters.has(c.key);
        chip.className = "chip" + (active ? " active": "");
        chip.textContent = c.label;
        chip.addEventListener("click", () => {
          if(activeFilters.has(c.key)) activeFilters.delete(c.key);
          else activeFilters.add(c.key);

          const allKeys = new Set((activeTrip.categories || []).map(x => x.key));
          let allSelected = true;
          for(const k of allKeys) if(!activeFilters.has(k)) allSelected = false;
          if(allSelected) activeFilters.clear();

          renderFilterChips();
          addMarkers();
          renderPoiList($("searchInput").value);
        });
        chips.appendChild(chip);
      }
    }

    // =========================================================
    // TRIP TABS INSIDE MAP
    // =========================================================
    function renderTripTabs(){
      const box = $("tripTabs");
      box.innerHTML = "";

      trips.forEach(t => {
        const tab = document.createElement("div");
        tab.className = "chip" + (t.id === activeTrip.id ? " active" : "");
        tab.textContent = t.name.split("·")[0].trim(); // short label
        tab.title = t.name;
        tab.addEventListener("click", () => setTrip(t));
        box.appendChild(tab);
      });
    }

    // =========================================================
    // CONTENT RENDERERS
    // =========================================================
    function renderItinerary(){
      const c = $("itineraryContainer");
      const days = activeTrip.itinerary || [];
      if(days.length === 0){
        c.innerHTML = `<p style="color: var(--muted); margin: 0; padding: 8px">No itinerary loaded for this trip yet.</p>`;
        return;
      }

      c.innerHTML = days.map((d, idx) => {
        const open = idx === 0 ? "open" : "";
        const items = (d.items || []).map(x => `<li>${escapeHtml(x)}</li>`).join("");
        const gmap = (activeTrip.googleMapUrl && activeTrip.googleMapUrl !== "#")
          ? activeTrip.googleMapUrl
          : "#mapSection";
        return `
          <details ${open} id="${escapeHtml(d.id)}">
            <summary>
              <span>${escapeHtml(d.title)}</span>
              <span class="sumMeta">${escapeHtml(d.meta || "")}</span>
            </summary>
            <div class="detailsBody">
              <ul>${items}</ul>
              <div class="anchorNote">
                <a class="btn btnPrimary" href="#mapSection">Use map for this day</a>
                <a class="btn" href="${gmap}" target="${gmap.startsWith("http") ? "_blank" : "_self"}" rel="noopener">Open Google Map</a>
              </div>
            </div>
          </details>
        `;
      }).join("");
    }

    function renderRestaurants(){
      const el = $("restaurantCards");
      const rs = activeTrip.restaurants || [];
      if(rs.length === 0){
        el.innerHTML = `<div class="rcard"><h4>No restaurant data</h4><p>Add restaurants in the trip object.</p></div>`;
        return;
      }

      el.innerHTML = rs.map(r => `
        <div class="rcard">
          <h4>${escapeHtml(r.name)} <span style="color:var(--muted); font-weight:700; font-size:12px">· ${escapeHtml(r.city || "")}</span></h4>
          <p>${escapeHtml(r.why || "")}</p>
          <div class="chipsRow">
            <span class="tag">${escapeHtml(r.vibe || "Recommended")}</span>
            <span class="tag">${escapeHtml(r.price || "$$")}</span>
            <a class="tag" href="${makeGoogleLink(r.google || r.name)}" target="_blank" rel="noopener">Open in Maps</a>
          </div>
        </div>
      `).join("");
    }

    function renderPhotos(){
      const el = $("photoCards");
      const ps = activeTrip.photoSpots || [];
      if(ps.length === 0){
        el.innerHTML = `<div class="rcard"><h4>No photo spots</h4><p>Add photo spots in the trip object.</p></div>`;
        return;
      }

      el.innerHTML = ps.map(p => `
        <div class="rcard">
          <h4>${escapeHtml(p.name)} <span style="color:var(--muted); font-weight:700; font-size:12px">· ${escapeHtml(p.city || "")}</span></h4>
          <p><strong style="color:var(--text)">Best:</strong> ${escapeHtml(p.best || "")}</p>
          <p style="margin-top:6px"><strong style="color:var(--text)">Shot:</strong> ${escapeHtml(p.shot || "")}</p>
          <p style="margin-top:6px"><strong style="color:var(--text)">Tip:</strong> ${escapeHtml(p.tip || "")}</p>
          <div class="chipsRow">
            <a class="tag" href="${makeGoogleLink(p.google || p.name)}" target="_blank" rel="noopener">Open in Maps</a>
          </div>
        </div>
      `).join("");
    }

    function renderBudget(){
      const el = $("budgetPanel");
      const b = activeTrip.budget;
      if(!b){
        el.innerHTML = `<p style="color: var(--muted); margin: 0; padding: 8px">No budget provided for this trip.</p>`;
        return;
      }

      const items = (b.items || []).map(i => `
        <div class="rcard" style="padding:12px">
          <h4 style="margin:0">${escapeHtml(i.label)}</h4>
          <p style="margin-top:6px; font-size:16px; color:var(--text); font-weight:800">${escapeHtml(i.value)}</p>
        </div>
      `).join("");

      el.innerHTML = `
        <details open>
          <summary>
            <span>${escapeHtml(b.headline || "Budget")}</span>
            <span class="sumMeta">Breakdown</span>
          </summary>
          <div class="detailsBody">
            <div class="cards" style="grid-template-columns: repeat(5, 1fr); gap:10px">
              ${items}
            </div>
          </div>
        </details>
      `;

      // responsive fix for 5-up grid inside budget
      if(window.innerWidth < 1020){
        el.querySelector(".cards").style.gridTemplateColumns = "1fr";
      }
    }

    // =========================================================
    // TRIP NAV (header + footer)
    // =========================================================
    function renderTripSelect(){
      const sel = $("tripSelect");
      sel.innerHTML = trips.map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join("");
      sel.value = activeTrip.id;
      sel.addEventListener("change", () => {
        const next = trips.find(t => t.id === sel.value);
        if(next) setTrip(next);
      });
    }

    function renderFooterTrips(){
      const box = $("footerTrips");
      box.innerHTML = trips.map(t => `<a href="#" data-trip="${escapeHtml(t.id)}">${escapeHtml(t.name)}</a>`).join("");
      box.querySelectorAll("a[data-trip]").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const id = a.getAttribute("data-trip");
          const next = trips.find(t => t.id === id);
          if(next) setTrip(next);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });
    }

    // =========================================================
    // SHARE
    // =========================================================
    async function copyShareLink(){
      const url = new URL(window.location.href);
      url.searchParams.set("trip", activeTrip.id);
      try{
        await navigator.clipboard.writeText(url.toString());
        alert("Share link copied.");
      }catch{
        prompt("Copy this link:", url.toString());
      }
    }

    // =========================================================
    // SET TRIP (single source of truth)
    // =========================================================
    function setTrip(trip){
      activeTrip = trip;
      activeFilters.clear();

      $("siteSubtitle").textContent = trip.short || "Interactive trip guide";
      $("kickerText").textContent = trip.short || "Trip guide";
      $("heroTitle").textContent = trip.heroTitle || trip.name;
      $("heroSub").textContent = trip.heroSub || "";

      // Meta pills
      const metaRow = $("metaRow");
      metaRow.innerHTML = "";
      (trip.meta || []).forEach(m => {
        const div = document.createElement("div");
        div.className = "pill";
        div.textContent = m;
        metaRow.appendChild(div);
      });

      // Google map URLs (if missing, we keep "#" but pin links still open via search)
      $("openMapBtn").href = trip.googleMapUrl || "#";
      $("primaryCta").href = trip.googleMapUrl || "#";
      $("itineraryOpenMapBtn").href = trip.googleMapUrl || "#";
      $("stickyOpenMap").href = trip.googleMapUrl || "#";
      $("footerOpenMap").href = trip.googleMapUrl || "#";
      $("drawerOpenGoogleBtn").href = (trip.googleMapUrl && trip.googleMapUrl !== "#") ? trip.googleMapUrl : "#";

      // Footer
      $("footerBrand").textContent = trip.name;
      $("footerDesc").textContent = trip.short || "Interactive guide";
      $("footerMeta").textContent = "Map + plan + food + photo spots. Built for execution.";

      // Update header selector
      $("tripSelect").value = trip.id;

      // Update URL param
      const url = new URL(window.location.href);
      url.searchParams.set("trip", trip.id);
      window.history.replaceState({}, "", url);

      // Map view + content
      map.setView(trip.mapView.center, trip.mapView.zoom);
      renderTripTabs();
      renderFilterChips();
      addMarkers();
      renderPoiList($("searchInput").value || "");
      renderItinerary();
      renderRestaurants();
      renderPhotos();
      renderBudget();
      renderFooterTrips();
      showDrawer(false);
    }

    // =========================================================
    // INIT + EVENTS
    // =========================================================
    function wireEvents(){
      $("drawerBtn2").addEventListener("click", () => showDrawer(true));
      $("openDrawerBtn").addEventListener("click", () => showDrawer(true));
      $("closeDrawerBtn").addEventListener("click", () => showDrawer(false));

      $("fitBtn").addEventListener("click", () => addMarkers());

      $("toggleLabelsBtn").addEventListener("click", () => {
        labelsEnabled = !labelsEnabled;
        $("toggleLabelsBtn").textContent = labelsEnabled ? "Labels" : "No labels";
        addMarkers();
      });

      $("searchInput").addEventListener("input", (e) => renderPoiList(e.target.value));
      $("clearSearchBtn").addEventListener("click", () => {
        $("searchInput").value = "";
        renderPoiList("");
      });

      $("copyShareBtn").addEventListener("click", copyShareLink);
      $("footerShare").addEventListener("click", (e) => { e.preventDefault(); copyShareLink(); });
      $("stickyPins").addEventListener("click", () => showDrawer(true));
    }

    document.addEventListener("DOMContentLoaded", () => {
      $("year").textContent = new Date().getFullYear();

      // URL param: ?trip=yucatan-8d
      const params = new URLSearchParams(window.location.search);
      const t = params.get("trip");
      if(t){
        const found = trips.find(x => x.id === t);
        if(found) activeTrip = found;
      }

      renderTripSelect();
      initMap();
      wireEvents();

      setTrip(activeTrip);
    });
  </script>
</body>
</html>
